service: fifo-leaderboard

frameworkVersion: ">=1.8.0 <2.0.0"

provider:
  name: aws
  runtime: nodejs6.10
  versionFunctions: false
  iamRoleStatements:
    - Effect: Allow
      Action:
        - sqs:*
      Resource:
        - arn:aws:sqs:${env:AWS_REGION}:${env:AWS_ACCOUNT_ID}:scoreQueue.fifo*
    - Effect: Allow
      Action:
        - dynamodb:Query
        - dynamodb:Scan
        - dynamodb:GetItem
        - dynamodb:PutItem
        - dynamodb:UpdateItem
        - dynamodb:BatchWriteItem
        - dynamodb:DeleteItem
        - dynamodb:DescribeTable
        - dynamodb:BatchGetItem
      Resource:
        - arn:aws:dynamodb:${env:AWS_REGION}:${env:AWS_ACCOUNT_ID}:table/${self:custom.dynamodb.tables.leaderboardTable.baseTable}*
        - arn:aws:dynamodb:${env:AWS_REGION}:${env:AWS_ACCOUNT_ID}:table/${self:custom.dynamodb.tables.lockTable.baseTable}*
        - arn:aws:dynamodb:${env:AWS_REGION}:${env:AWS_ACCOUNT_ID}:table/${self:custom.dynamodb.tables.semaphoreTable.baseTable}*
    - Effect: Allow
      Action:
        - lambda:InvokeFunction
      Resource:
        - arn:aws:lambda:${env:AWS_REGION}:${env:AWS_ACCOUNT_ID}:function:*

plugins:
  - serverless-plugin-typescript

package:
  include:
    - src/
  exclude:
    - config/**
    - .envrc
    - .gitignore
    - package.json
    - yarn.lock
    - src/yarn.lock
    - src/package.json
    - README.md
    - .eslintrc.yml
    - tests/**
    - coverage/**
    - "*.sh"
    - "**/*.test.js"
    - npm-packages-offline-cache/**
    - src/__mocks__/**

custom:
  kinesis:
    streams:
      scoreStream: ${self:service}-${opt:stage}-scoreStream
  dynamodb:
    tables:
      semaphoreTable:
        baseTable: ${self:service}-${opt:stage}-semaphoreTable
      lockTable:
        baseTable: ${self:service}-${opt:stage}-lockTable
      leaderboardTable:
        baseTable: ${self:service}-${opt:stage}-leaderboardTable
        gsi:
          scoresByDatedScoreBlock: ${self:service}-${opt:stage}-leaderboardTable-scoresByDatedScoreBlock

functions:
  # Methods
  testFunction:
    handler: src/test-fn.handler
    environment:
      SCORES_BY_DATED_SCORE_BLOCK_INDEX: ${self:custom.dynamodb.tables.leaderboardTable.gsi.scoresByDatedScoreBlock}
      LEADERBOARD_TABLE: ${self:custom.dynamodb.tables.leaderboardTable.baseTable}

  semaphoreHandler:
    handler: src/semaphore-processor.handler
    timeout: 300
    memorySize: 256
    environment:
      LEADERBOARD_TABLE: ${self:custom.dynamodb.tables.leaderboardTable.baseTable}
      SEMAPHORE_TABLE: ${self:custom.dynamodb.tables.semaphoreTable.baseTable}
    events:
      - schedule: rate(1 minute)

  dummyReaderWriter:
    handler: src/dummy-reader-writer.handler
    timeout: 300
    memorySize: 256
    environment:
      LEADERBOARD_TABLE: ${self:custom.dynamodb.tables.leaderboardTable.baseTable}
    events:
      - schedule: rate(1 minute)

  scoreWriterHandler:
    handler: src/score-writer.handler
    timeout: 300
    memorySize: 1536
    environment:
      LEADERBOARD_TABLE: ${self:custom.dynamodb.tables.leaderboardTable.baseTable}
      SEMAPHORE_TABLE: ${self:custom.dynamodb.tables.semaphoreTable.baseTable}
      SELF_FUNCTION: ${self:service}-${opt:stage}-scoreWriterHandler
    events:
      - schedule: rate(1 minute)      

  getLeaderboard:
    handler: src/get-leaderboard.handler
    environment:
      SCORES_BY_DATED_SCORE_BLOCK_INDEX: ${self:custom.dynamodb.tables.leaderboardTable.gsi.scoresByDatedScoreBlock}
      LEADERBOARD_TABLE: ${self:custom.dynamodb.tables.leaderboardTable.baseTable}  
    events:
      - http:
          path: leaderboard
          method: get
          cors: true

resources:
  Resources:
    scoreQueue:
      Type: "AWS::SQS::Queue"
      Properties:
        QueueName: scoreQueue.fifo
        FifoQueue: true
        ContentBasedDeduplication: true
        VisibilityTimeout: 300
    leaderboardTable:
      Type: AWS::DynamoDB::Table
      DeletionPolicy: Delete
      Properties:
        TableName: ${self:custom.dynamodb.tables.leaderboardTable.baseTable}
        AttributeDefinitions:
          - AttributeName: userId
            AttributeType: S # eg. <uuid>
          - AttributeName: datedScore
            AttributeType: S # eg. month_2017/09
          # - AttributeName: datedScoreBlock
          #   AttributeType: S # eg. month_2017/09_1
          # - AttributeName: score
          #   AttributeType: N # eg. 10
        KeySchema:
          # Allows us to fetch a scores by a specific userId
          - AttributeName: userId
            KeyType: HASH
          - AttributeName: datedScore
            KeyType: RANGE
        ProvisionedThroughput:
          ReadCapacityUnits: 500
          WriteCapacityUnits: 500
        # GlobalSecondaryIndexes:
        #   # Allows us to lookup top scores in a block
        #   - IndexName: ${self:custom.dynamodb.tables.leaderboardTable.gsi.scoresByDatedScoreBlock}
        #     KeySchema:,
        #      - AttributeName: datedScoreBlock
        #        KeyType: HASH
        #      - AttributeName: score
        #        KeyType: RANGE
        #     Projection:
        #       ProjectionType: ALL
        #     ProvisionedThroughput:
        #       ReadCapacityUnits: 5
        #       WriteCapacityUnits: 5

    semaphoreTable:
      Type: AWS::DynamoDB::Table
      DeletionPolicy: Delete
      Properties:
        TableName: ${self:custom.dynamodb.tables.semaphoreTable.baseTable}
        ProvisionedThroughput:
          ReadCapacityUnits: 1
          WriteCapacityUnits: 1
        AttributeDefinitions:
          - AttributeName: semaphore_key
            AttributeType: S
          - AttributeName: semaphore_sort_key
            AttributeType: S            
        KeySchema:
          - AttributeName: semaphore_key
            KeyType: HASH
          - AttributeName: semaphore_sort_key
            KeyType: RANGE
        TimeToLiveSpecification:
          AttributeName: 'expires'
          Enabled: true          